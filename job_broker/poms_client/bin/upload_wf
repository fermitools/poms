#!/usr/bin/env python

import sys
import os
import ConfigParser
import poms_client
import json
import logging
import argparse

class uploader:

    def __init__(self, cfgfile, args):
        self.cfg = ConfigParser.SafeConfigParser()
        self.cfg.optionxform = str
        self.cfg.read(cfgfile)
        print("DEBUG: config file %s read:\n-------" % cfgfile)
        self.cfg.write(sys.stdout)
        print("-----")
        if self.cfg.has_section('global'):
            self.cfg_globals = dict(self.cfg.items('global'))
        else:
            self.cfg_globals = dict()

        role = args.poms_role
        if self.cfg_get('campaign','poms_role'):
            role = self.cfg_get('campaign','poms_role') 

        poms_client.update_session_role(role)

    def cfg_get(self,section,item):
        try:
            return self.cfg.get(section,item,vars=self.cfg_globals)
        except ConfigParser.NoOptionError:
            return None
        except ConfigParser.NoSectionError:
            return None

    def upload_wf(self, testflag = None, action = 'add'):
        campaign_name = self.cfg.get('campaign', 'name')
        cfg_stages = self.cfg_get('campaign','campaign_stage_list').split()
        cfg_jobtypes = set()
        cfg_launches = set()

        campaign_id = poms_client.get_campaign_id(campaign_name = campaign_name, test = testflag)

        for s in cfg_stages:
            cfg_jobtypes.add(self.cfg_get('campaign_stage %s'%s, 'job_type'))
            cfg_launches.add(self.cfg_get('campaign_stage %s'%s, 'login_setup'))
            
        for l in cfg_launches:
            self.upload_login_setup(l, testflag, action)
        for jt in cfg_jobtypes:
            self.upload_jobtype(jt, testflag, action)
        for s in cfg_stages:
            self.upload_stage(s, testflag, action, campaign_id)


    def tag_em(self, tag, cfg_stages, testflag = False):
        cname_id_map = poms_client.get_campaign_list(test_client=testflag)
        print("got map: %s" % repr(cname_id_map))
        cids = map((lambda x:str(cname_id_map[x])), cfg_stages)
        poms_client.tag_campaigns(tag = tag, cids = ','.join(cids), experiment=self.cfg_get('campaign','experiment'), test_client = testflag)

    def upload_jobtype(self,jt, testflag = None, action = 'add'):
        field_map = {
            'launch_script':'launch_script',
            'parameters':'def_parameter',
            'output_file_patterns':'output_file_patterns',
        }
        d=dict(self.cfg.items('job_type %s'%jt))
        print( "I should upload jt %s" % jt)
        print(repr(d))
        args = {
            'action': action, 
            'name': jt, 
            'experiment': self.cfg_get('campaign','experiment'), 
            'pc_username': os.environ['USER'],
            'test_client': testflag,
        }
        for k in d.keys():
            args[field_map.get(k,k)] = d[k]
        # lauch script wants a list(?)
        args['launch_script'] = [args['launch_script']]
        args['def_parameter'] =  json.loads(args['def_parameter'])
        print("args:%s" % repr(args))
        poms_client.campaign_definition_edit(**args)

    def upload_login_setup(self,lt, testflag = None, action = 'add'):
        field_map = {
            'host': 'launch_host',
            'account': 'user_account',
            'setup': 'launch_setup',
        }
        d = dict(self.cfg.items('login_setup %s' % lt))
        print( "I should upload lt %s" % lt)
        print( repr(d))
        args = {
             'action': action, 
             'launch_name': lt, 
             'experiment': self.cfg_get('campaign','experiment'), 
             'pc_username': os.environ['USER'],
             'test_client': testflag,
        }
        for k in d.keys():
            args[field_map.get(k,k)] = d[k]
        # launch_setup wants a list(?)
        args['launch_setup'] = [ args['launch_setup'] ]
        poms_client.launch_template_edit(**args)
        
    def upload_stage(self,st, testflag = None, action = 'add', campaign_id = None):
        field_map = {
            'dataset': 'dataset',
            'software_version': 'ae_software_version',
            'vo_role': 'vo_role',
            'cs_split_type': 'ae_split_type',
            'job_type': 'ae_campaign_definition',
            'login_setup': 'ae_launch_name',
            'param_overrides': 'ae_param_overrides',
            'completion_type': 'ae_completion_type',
            'completion_pct': 'ae_completion_pct',
            'test_param_overrides': 'ae_test_param_overrides',
            'state': 'ae_active',
        }
        deps = {"file_patterns":[], "campaigns":[]}
        for i in range(1,10):
            dst = self.cfg_get('dependencies %s' % st, 'campaign_stage_%d'%i)
            if dst:
                pat = self.cfg_get('dependencies %s' % st, 'file_pattern_%d'%i)
                deps["campaigns"].append(dst)
                deps["file_patterns"].append(pat)
        d=dict(self.cfg.items('campaign_stage %s'%st))
        print( "I should upload s %s" % st)
        print( repr(d))
        print( "deps: %s" % repr(deps))
        args = {
            'action': action, 
            'ae_stage_name': st,  
            'experiment': self.cfg_get('campaign','experiment'), 
            'ae_active': True, 
            'ae_depends': json.dumps(deps),
            'campaign_id': campaign_id,
            'pc_username' : os.environ['USER']
        }
        args['test_client'] = testflag
        for k in d.keys():
            args[field_map.get(k,k)] = d[k]
        print("args:%s" % repr(args))
        poms_client.campaign_stage_edit(**args)

if __name__ == '__main__':
    logging.basicConfig(level=logging.DEBUG)

    parser = argparse.ArgumentParser(description='Optional arguments edit campaign')
    parser.add_argument('--test', help='use test POMS ', default = None)
    parser.add_argument('--poms_role', type=str, help='set role in poms session', default = 'production')
    parser.add_argument('--action', type=str, help='say whether to "add" new or "edit" (update) existing records', default = 'add')
    parser.add_argument('--dev', action='store_const', const='dev', dest='test' , metavar='',  help='use the dev/test instance of POMS')
    parser.add_argument('--int', action='store_const', const='int', dest='test' , metavar='',  help='use the int/integration instance of POMS')
    parser.add_argument('ini_file',help='.ini file containing campaign description')
    args = parser.parse_args()

    if args.test:
        testflag = args.test

    u=uploader(sys.argv[-1], args)
    u.upload_wf(testflag, args.action)

