#!/usr/bin/env python

import sys
import ConfigParser

class uploader:

    def __init__(self, cfgfile):
        self.cfg = ConfigParser.SafeConfigParser()
        self.cfg.optionxform = str
        self.cfg.read(cfgfile)
        if self.cfg.has_section('global'):
            self.cfg_globals = dict(self.cfg.items('global'))
        else:
            self.cfg_globals = dict()

    def cfg_get(self,section,item):
        try:
            return self.cfg.get(section,item,vars=self.cfg_globals)
        except ConfigParser.NoOptionError:
            return None
        except ConfigParser.NoSectionError:
            return None

    def upload_wf(self, testflag = None):
        cfg_stages = set(self.cfg_get('campaign','campaign_stage_list').split())
        cfg_jobtypes = set()
        cfg_launches = set()
        print("here")
        for s in cfg_stages:
            cfg_jobtypes.add(self.cfg_get('campaign_stage %s'%s, 'job_type'))
            cfg_launches.add(self.cfg_get('campaign_stage %s'%s, 'launch_template'))
            
        for l in cfg_launches:
            self.upload_launch_template(l, testflag)
        for jt in cfg_jobtypes:
            self.upload_jobtype(jt, testflag)
        for s in cfg_stages:
            self.upload_stage(s, testflag)


    def upload_jobtype(self,jt, testflag = None):
        field_map = {
            'launch_script':'launch_script',
            'parameters':'def_parameter',
            'output_file_patterns':'output_file_patterns',
        }
        d=self.cfg.items('job_type %s'%jt)
        print( "I should upload jt %s" % jt)
        print( repr(d))
        args = {'action': 'add', 'name': jt, 'pc_username': os.environ['USER']}
        args['test'] = testflag
        for k in d.keys():
            args[field_map[k]] = d[k]
        poms_client.campaign_definition_edit(**args)

    def upload_launch_template(self,lt, testflag = None):
        field_map = {
            'host': 'launch_host',
            'account': 'user_account',
            'setup': 'launch_setup',
        }
        d = dict(self.cfg.items('launch_template %s' % lt))
        print( "I should upload lt %s" % lt)
        print( repr(d))
        args = {'action': 'add', 'launch_name': lt, 'pc_username': os.environ['USER']}
        args['test'] = testflag
        for k in d.keys():
            args[field_map[k]] = d[k]
        poms_client.edit_launch_template(**args)
        
    def upload_stage(self,st, testflag = None):
        field_map = {
            'dataset': '',
            'software_version': 'ae_software_version',
            'vo_role': 'vo_role',
            'cs_split_type': 'ae_split_type',
            'job_type': 'ae_campaign_definition',
            'launch_template': 'ae_launch_name',
            'param_overrides': 'ae_param_overrides',
            'completion_type': 'ae_completion_type',
            'completion_pct': 'ae_completion_pct',
        }
        deps = {"file_patterns":[], "campaigns":[]}
        for i in range(1,10):
            dst = self.cfg_get('dependencies %s' % st, 'campaign_stage_%d'%i)
            if dst:
                pat = self.cfg_get('dependencies %s' % st, 'file_pattern_%d'%i)
                deps["campaigns"].append(dst)
                deps["file_patterns"].append(pat)
        d=self.cfg.items('campaign_stage %s'%st)
        print( "I should upload s %s" % st)
        print( repr(d))
        print( "deps: %s" % repr(deps))
        args = {'action': 'add', 'ae_depends', json.dumps(deps), 'pc_username' : os.environ['USER']}
        args['test'] = testflag
        for k in d.keys():
            args[field_map[k]] = d[k]
        poms_client.campaign_edit(**args)

testflag = None
if sys.argv[1] == '-t':
    testflag = True
    sys.argv = sys.argv[1:]
u=uploader(sys.argv[1])
u.upload_wf(testflag)

