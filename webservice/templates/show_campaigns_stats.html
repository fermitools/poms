{%extends "layout.html"%}

{%block title%}
POMS:Selected Campaign Stages
{%endblock%}

{%block header%}
Selected Campaign Stages{%include 'help_button.html'%}
{%endblock%}

{%block content%}

  {%set column_heads = ['All','Idle','Running','Held','Total Completed','Completed', 'Located', 'Removed', 'Failed', 'efficiency', 'pending'] %}

  <div id="double-scroll" class="ui scrollable">

   <table class="ui celled table unstackable">
     <tr>
       <th colspan = 5></th>
       <th colspan = 4>Jobs in  {{time_range_string}}</th>
     </tr>
     <tr>
       <th colspan=1 align="center"> Campaign Stage
        <a target="_help" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#CampaignStage"><i style="float: none" class="grey help circle link icon"></i></a>
      </th>
      <th>Total</th>
      <th colspan=3 align="center">Active Jobs </th>
      <th colspan=4 align="center">Completed </th>
      <th colspan=1 align="center"></th>
      <th colspan=2 align="center">Stats</th>
     </tr>
     <tr>
        <!-- <th>Experiment </th> -->
        <th>Name </th>
        <th>All</th>
        <th>Idle<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Running<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Held<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Total<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Not&nbsp;Located<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Located<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Removed<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Failed<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>%Efficiency<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
        <th>Pending<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a> </th>
     </tr>

     {# for cs in campaign_stages if not cs.experiment_obj.restricted or current_experimenter.is_authorized(cs.experiment) #}
     {# for cs in campaign_stages if not cs.experiment_obj.restricted or cs.experiment in current_experimenter.extra.selected #}
     {# for cs in campaign_stages if current_experimenter.extra and cs.experiment in current_experimenter.extra.selected #}
     {% for cs in campaign_stages %}
     {% set outer_loop = loop %}
            <tr>
            <!-- <td>{{cs.experiment}}</td> -->
            <!-- cs.experiment_obj.restricted: {{cs.experiment_obj.restricted}} -->
            <!-- current_experimenter.is_authorized(cs.experiment): {{current_experimenter}} -->
            {#<!-- cs.experiment in current_experimenter.extra.selected {{cs.experiment in current_experimenter.extra.selected}}-->#}
            <td> <a href="{{pomspath}}/campaign_info?campaign_stage_id={{cs.campaign_stage_id}}">{{cs.name}}</a></td>
            {% for k in column_heads  %}

              {% if k == "efficiency" %}
                <td>
                  <a href="{{pomspath}}/jobs_eff_histo?campaign_stage_id={{cs.campaign_stage_id}}&tmin={{tmins}}&tmax={{tmaxs}}&tdays={{tdays}}" id="data_{{cs.campaign_stage_id}}_{{k}}">
                      ...
                  </a>
                </td>
              {% elif k == "pending" %}
                <td>
                  <a href="{{pomspath}}/actual_pending_files?campaign_stage_id={{cs.campaign_stage_id}}&tmin={{tmins}}&tmax={{tmaxs}}&tdays={{tdays}}" id="data_{{cs.campaign_stage_id}}_{{k}}">
                     ...
                  </a>
                </td>
              {% elif k %}
                <td>
                  <a href="{{pomspath}}/job_table?campaign_stage_id={{cs.campaign_stage_id}}&job_status={{k}}&tmin={{tmins}}&tmax={{tmaxs}}&tdays={{tdays}}" id="data_{{cs.campaign_stage_id}}_{{k|replace(' ','_')}}">
                     ...
                  </a>
                 </td>
               {%endif%}
            {% endfor %}
         </tr>

     {% endfor %}

    </table>
  </div>

<script>
    var tmin_local_time = moment.utc('{{tmin}}').toDate();
    tmin_local_time = moment(tmin_local_time).format('YYYY-MM-DD HH:mm');
    $( ".tmin" ).html( tmin_local_time );

    var tmax_local_time = moment.utc('{{tmax}}').toDate();
    tmax_local_time = moment(tmax_local_time).format('YYYY-MM-DD HH:mm');
    $( ".tmax" ).html( tmax_local_time );

</script>

<!-- now some JSON callbacks to get our
      * job counts for each campaign,
      * efficiency for all the campaign_stages
      * pending counts for all the campaign_stages
-->

<script>
    $(function() {

        var now = new Date()
        var nows = now.getTime()
        nows = nows - (nows % 300000)
        nows = nows.toString()

        {% for campaign in campaign_stages %}
        $.getJSON("/poms/json_job_counts?tmin={{tmins}}&tmax={{tmaxs}}&campaign_stage_id={{campaign.campaign_stage_id}}&uuid="+nows,function(data){
            for( var k in data ) {
               id = "data_{{campaign.campaign_stage_id}}_" + k.replace(" ","_")
               console.log("trying to update a with id " + id )
               $("a#"+id).html(data[k])
            }
        })
        {% endfor %}
        $.getJSON("/poms/json_efficiency_for_campaigns?tmin={{tmins}}&tmax={{tmaxs}}&cl={{ campaign_stages | join(',', attribute='campaign_stage_id') }}&uuid="+nows, function(data) {
            for (var k in data) {
               id = "data_"+k+"_efficiency"
               console.log("trying to update a with id " + id )
               $("a#"+id).html(data[k])
            }
        })
        $.getJSON("/poms/json_pending_for_campaigns?tmin={{tmins}}&tmax={{tmaxs}}&cl={{ campaign_stages | join(',', attribute='campaign_stage_id') }}&uuid="+nows, function(data) {
            for (var k in data) {
               id = "data_"+k+"_pending"
               console.log("trying to update a with id " + id )
               if (data[k] == -1) {
                   $("a#"+id).html('N/A')
               } else {
                   $("a#"+id).html(data[k])
               }
            }
        })
    });
</script>

<script>
    $('.external')
      .popup({
        inline   : true,
        hoverable: true,
        delay: {
          show: 300,
          hide: 80
        }
      })
    ;
    $('.ui.dropdown')
      .dropdown()
    ;
</script>


<script>
   $(function() {
       $('#global_datepicker_container').show();
   });

   $(document).ready(function(){
     $('#double-scroll').doubleScroll();
   });
</script>

{%endblock%}
