{%extends "layout.html"%}

{% macro show_hint(anchor, hint) %}
    {% include 'help_button.html' %}
{% endmacro %}

{%block header%}
Campaigns {%include 'help_button.html'%}
{%endblock%}

{%block subheader%}
&nbsp;
{%endblock%}

{%block content%}

<style scoped>
    /* Hide the first column with IDs */
    #campaign_table th:nth-child(1), table td:nth-child(1) {
        display: none;
    }

    stagelink {
        background-color: yellow;
    }

</style>

<form name="view_picker_form" id="view_picker_form" method="GET" action="show_campaigns">
{% set has_active=True %}
{% set data = data|default({}) %}
{%include "view_picker.html" %}
</form>
<br>
<div class="tiny ui teal button" onclick="pop_mark_inactive_modal();">Mark Campaign Active/Inactive</div>
<div class="tiny ui teal button" onclick="pop_tag_untag_modal();">
    <i class="icon tags"></i>
    Tag/untag Campaigns
</div>
<button class="tiny ui labled teal icon button" onclick="pop_add_campaign_modal();" {{ 'disabled' if (session_role=='coordinator') }}>
    <i class="icon add square"></i>
    Add
</button>

<div>
    <table id="campaign_table" class="ui celled _table unstackable tablesorter tablesorter-ice">
        <thead>
            <tr>
                <th data-sorter="false" data-filter="false">Id</th>
                <th data-sorter="false" data-filter="false" align="center">
                        Select All<br><input type="checkbox" id="c_cbox_all" onchange="do_checkall();">
                <th>Campaign Name</th>
                <th>Active</th>
                <th>Submissions<br>Running</th>
                <th data-sorter="false" data-filter="false">Submission<br>History</th>
                <th data-sorter="false" data-filter="false">Dependencies</th>
                <th data-sorter="false" data-filter="false">GUI Editor</th>
                <th data-sorter="false" data-filter="false">Clone<br>Campaign</th>
                <th data-sorter="false" data-filter="false">.ini File</th>
                <th>Tags</th>
                <th data-sorter="false" data-filter="false">Rename<br>Campaign</th>
                <th data-sorter="false" data-filter="false">Delete<br>Campaign</th>
                <th>Creator</th>
            </tr>
        </thead>
        <tbody>
        {% for s in tl|sort(attribute='name') %}
            <tr id="c_tr_{{loop.index}}">
                <!-- id is hidden by css look for #campaign_table above -->
                <td id="c_id_{{loop.index}}">{{s.campaign_id}}</td>
                <td align="center"><input type="checkbox" id="c_cbox_{{loop.index}}"></td>
                <td><a class="stagelink" href="{{pomspath}}/show_campaign_stages?campaign_name={{s.name|urlencode}}">{{s.name}}</a></td>
                <td align="center">{{ 'Yes' if s.active else 'No' }}</td>
		        <!-- <td> <button onclick="call_show_campaign_stages( '{{s.name}}' )"> {{s.name}} </td> -->
                <td id="running_{{s.campaign_id}}" style="text-align:right; padding-right: 1em">...</td>
                <td>
                    <a href="{{pomspath}}/campaign_time_bars?tag={{s.name|urlencode}}&tdays=7&tmax={{last_activity}}">
                        <button type="button">
                        <i class="chart line icon"></i>
                        </button>
                    </a>
                </td>
                <td>
                    <a href="{{pomspath}}/campaign_deps?tag={{s.name|urlencode}}">
                        <button type="button">
                            <i class="sitemap icon"></i>
                        </button>
                    </a>
                </td>
                <td>
                    <a href="{{pomspath}}/gui_wf_edit?campaign={{s.name|urlencode}}">
                        <button {{ 'class="ui disabled button"' if (data.authorized[loop.index] == false) }}>
                            <i class="edit icon"></i>
                        </button>
                    </a>
                </td>
                <td>
                    <button type="button" onclick="clone_template('{{s.name}}');">
                        <i class="copy blue icon"></i>
                    </button>
                </td>
                <td>
                    <a href="{{pomspath}}/campaign_deps_ini?tag={{s.name|urlencode}}">
                        <button type="button">
                            <i class="list icon"></i>
                        </button>
                    </a>
                </td>
                <td>
                    {% for tag in s.tags %}
                        {{tag.tag_name}}
                    {% endfor %}
                </td>
                <td>
                    <button {{ 'class="ui disabled button"' if (data.authorized[loop.index] == false) }}>
                        <i class="exchange blue icon" onclick="rename_campaign('{{s.name}}', '{{s.campaign_id}}');"></i>
                    </button>
                </td>
                <td>
                    <button {{ 'class="ui disabled button"' if (data.authorized[loop.index] == false) }}>
                        <i class="trash blue icon" onclick="delete_campaign('{{s.name}}', '{{s.campaign_id}}');"></i>
                    </button>
                </td>
                <td>
                    {{s.experimenter_creator_obj.username}}
                </td>
                <td id="c_name_{{loop.index}}" style="display:none">{{s.name}}</td>
            </tr>

        {% endfor %}
        </tbody>
    </table>
    <input type="hidden" id="c_table_max_rows" value="{{tl|length}}">
</div>

<div class="ui modal small" name="mark_inactive_modal" id="mark_inactive_modal" style="padding: 0px 20px;">
        <i class="close icon"></i>
        <div class="header">
            Campaigns to mark Active/Inactive
        </div>
        <form class="ui form" action="mark_campaign_active" method="GET">
            <div class="field">
                <textarea id="campaign_names" readonly></textarea>
                <input type="hidden" id="campaign_ids" name="cl">
            </div>
            <div class="center inline fields">
                <div class="field">
                    <div class="ui radio checkbox">
                        <input type="radio" name="is_active" value="Active" checked="checked">
                        <label>Active</label>
                    </div>
                </div>
                <div class="field">
                    <div class="ui radio checkbox">
                        <input type="radio" name="is_active" value="Inactive">
                        <label>Inactive</label>
                    </div>
                </div>
            </div>
            <div class="field">
                <input type="submit" class="ui teal button" name="Submit">
            </div>
            <div class="ui hidden divider"></div>
        </form>
    </div> <!-- Ends mark_inactive_modal -->

<div class="ui modal" id="template_clone_modal">
  <i class="close icon"></i>
  <h3 class="block header"><span id="template_header">
      Clone Campaign </span> {{ show_hint('', 'Clone Campaign') }}
  </h3>
  <div class="ui hidden divider"></div>
  <div class="ui text container">
    <form id="template_clone_form" class="ui form" method="GET" action="{{pomspath}}/gui_wf_edit?">
      <div class="two fields">
        <div class="field">
          <label>Existing Campaign Name</label>
          <input type="text" id="from" name="from" readonly>
        </div>
        <div class="field">
          <label>Clone Campaign Name</label>
          <input type="text" id="to" name="to">
        </div>
      </div>
      <div class="actions">
        <div class="ui button deny red">Cancel</div>
        <input type="submit" id="clone" name="clone" value="Clone" class="ui button teal">
      </div>
      <input type="hidden" id="campaign" name="campaign">
    </form>
  </div>
  <div class="ui hidden divider"></div>
</div> <!-- Ends template_clone_modal -->

<div class="ui modal" id="delete_campaign_modal">
    <i class="close icon"></i>
    <h3 class="block header"><span id="template_header">
        Delete Campaign </span> {{ show_hint('', 'Delete Campaign') }}
    </h3>
    <div class="ui hidden divider"></div>
    <div class="ui text container">
        <div class="ui ignored warning message">
            <p>
                This will delete all stages of the campaign shown below.
                It will not delete job types or login setups.
                Deletions will <b>not</b> occur if the campaign has been submitted.
            </p>
        </div>
        <!-- <form id="delete_campaign_form" class="ui form" method="POST" action="{{pomspath}}/show_campaigns"> -->
        <form id="delete_campaign_form" class="ui form" method="POST" action="" onsubmit="this.action=location.href">
            <div class="one field">
                <div class="field">
                    <label>Campaign to Delete</label>
                    <input type="text" id="del_campaign_name" name="del_campaign_name" readonly>
                </div>
            </div>
            <div class="actions">
                <div class="ui button deny green">Cancel</div>
                <input type="submit" value="Delete" class="ui button red">
            </div>
            <input type="hidden" id="del_campaign_id" name="del_campaign_id">
            <input type="hidden" id="action" name="action" value="delete">
        </form>
    </div>
    <div class="ui hidden divider"></div>
  </div> <!-- Ends template_clone_modal -->

  <div class="ui modal small" id="tag_untag_modal" style="padding: 0px 20px;">
        <i class="close icon"></i>
        <div class="header">
        </div>
        <form class="ui form" action="" method="GET">
            <div class="field">
                <input type="hidden" id="tag_campaign_ids" name="cl" readonly>
                <span style="font-size: 1.3em;">Tag/untag selected campaigns...</span>
                <div class="ui segment raised">
                    <h3>Tags</h3>
                    <div class="ui search">
                        <div class="ui left icon input">
                            <input type="text" id="tag_field" name="tag" placeholder="Enter tag" class="prompt">
                            <i class="tag icon"></i>
                        </div>
                        <button class="ui icon small blue button" id="add_button">
                            <i class="plus icon"></i>
                        </button>
                        <div id="response" style="display:inline; vertical-align: bottom; font-style: italic;"></div>
                        <div class="results"></div>
                    </div>
                    <div id="tag_container">
                        {% for tag in tags %}
                            <i class="trash outline icon link poms_tag" id="{{Campaign.campaign_id}}_{{tag.tag_id}}"></i>
                            <a href="{{pomspath}}/search_tags?q={{tag.tag_name|urlencode}}" class="ui blue tag label" id="{{Campaign.campaign_id}}_{{tag.tag_id}}_">{{tag.tag_name}}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
          <div class="ui hidden divider"></div>
        </form>
        <div class="actions">
            <input type="submit" class="ui teal button approve" value="Done" onclick="return location.reload();">
        </div>
    </div> <!-- Ends Modal -->

    <div class="ui modal small" id="add_campaign_modal" style="padding: 0px 20px;">
        <i class="close icon"></i>
        <div class="header">
            <span style="font-size: 1.3em;">Create a new campaign.</span>
        </div>
        <form class="ui form" action="" method="GET">
            <div class="field">
                <input type="text" id="add_campaign_name" name="add_campaign_name" placeholder="Enter new campaign name" class="prompt">
            </div>
            <div class="ui hidden divider"></div>
        </form>
        <div class="actions">
            <div class="ui button deny red">Cancel</div>
            <div class="ui button approve teal">Save</div>
        </div>
    </div> <!-- Ends Modal -->

    <div class="ui modal small" id="rename_campaign_modal" style="padding: 0px 20px;">
        <i class="close icon"></i>
        <div class="header">
            <span style="font-size: 1.3em;">Rename a campaign.</span>
        </div>
        <form class="ui form" action="" method="GET">
            <div class="field">
                <lable>From:</lable>
                <input type="text" id="original_campaign_name" name="original_campaign_name" readonly>
                <lable>To:</lable>
                <input type="text" id="new_campaign_name" name="new_campaign_name">
            </div>
            <div class="ui hidden divider"></div>
        </form>
        <div class="actions">
            <div class="ui button deny red">Cancel</div>
            <div class="ui button approve teal">Save</div>
        </div>
    </div> <!-- Ends Modal -->

<script>
$(document).ready(function() {
    $('#campaign_table').tablesorter( {
        widgets : [ 'filter', 'saveSort' ],
        widgetOptions : {filter_reset: '.reset', saveSort: true},
        //dateFormat : "yyyymmdd"
        });

    if ('{{msg}}' != 'OK') {
        $("#poms_message_data").text('{{msg}}');
        $("#display_message_modal").modal('show');
    }
    get_running();
});

$('#campaign_table')
.bind('filterInit', function() {
    // check that storage ulility is loaded
    if ($.tablesorter.storage) {
        // get saved filters

        var f = $.tablesorter.storage(this, 'tablesorter-filters') || [];
        $(this).trigger('search', [f]);
    }
})
.bind('filterEnd', function(){
    if ($.tablesorter.storage) {
        // save current filters
        var f = $(this).find('.tablesorter-filter').map(function() {
            return $(this).val() || '';
        }).get();
        $.tablesorter.storage(this, 'tablesorter-filters', f);
    }
});

function get_running() {
  $.ajax({
      url: "{{pomspath}}/running_submissions?campaign_id_list={%for c in tl %}{{c.campaign_id}},{%endfor%}-1",
      type: 'GET',
      dataType: 'json',
      success: update_running,
  })
}
function update_running(data) {
    var camp_id;
    var name;
    for (camp_id in data) {
      // console.log([camp_id, data[camp_id]])
       if (camp_id != "-1") {
          $("#running_"+camp_id).html( String(data[camp_id]))
       }
    }
}

$("a.stagelink").click(function() {
    var href = this.href
    if ( $("#view_active" ).is( ":checked" ) ) {
        href = href + "&view_active=view_active"
    }
    if ( $("#view_inactive" ).is( ":checked" ) ) {
        href = href + "&view_inactive=view_inactive"
    }
    if ( $("#view_mine" ).is( ":checked" ) ) {
        href = href + "&view_mine=" + $("#view_mine").val();
    }
    if ( $("#view_others" ).is( ":checked" ) ) {
        href = href + "&view_others=" + $("#view_others").val();
    }
    if ( $("#view_production" ).is( ":checked" ) ) {
        href = href + "&view_production=view_production"
    }
    if ( $("#view_analysis" ).is( ":checked" ) ) {
        href = href + "&view_analysis=view_analysis"
    }
    if ( href != this.href) {
        href = href + "&update_view=update_view"
    }
    this.href = href;
});

function clone_template(campaign_name) {
    $("#campaign").val(campaign_name);
    $("#from").val(campaign_name)
    $("#template_clone_modal").modal({}).modal('show');
}

function delete_campaign(del_campaign_name, del_campaign_id) {
    $("#del_campaign_name").val(del_campaign_name);
    $("#del_campaign_id").val(del_campaign_id);
    $("#delete_campaign_modal").modal({}).modal('show');
}

$('#template_clone_form')
  .form({
    inline: true,
    fields: {
      to      : {rules: [{type: 'empty',prompt: 'field cannot be blank'}]},
    }
  })
;

function do_checkall() {
    // console.log("In do_changeall");
    const max_rows = $("#c_table_max_rows").val();
    for (let i = 1; i <= max_rows; i++) {
        let $cba = $("#c_cbox_all");
        let $cb = $("#c_cbox_"+i);
        if ($cb.is(":visible") && !$cb.is(":disabled")) {
            $cb.prop("checked", $cba.prop("checked"));
        }
    }
}

function pop_add_campaign_modal() {
  $('#add_campaign_name').val("");
  $('#add_campaign_modal')
    .modal({
      closable  : false,
      onApprove : function() {
        var formdata = {'campaign_name': $("#add_campaign_name").val()};
        $.ajax({
            url: "{{pomspath}}/campaign_add_name",
            type: 'GET',
            data: formdata,
            success: function(data){
              data = JSON.parse(data);
              if (data.message != "ok") {
                mod_form= $("#display_message_modal").modal('show');
                $("#poms_message_data").text(data.message);
              } else {
                location.reload(true);
              }
            }
          });
        }
      })
    .modal('show');
  }

function rename_campaign(name, campaign_id) {
    $('#original_campaign_name').val(name);
    $('#new_campaign_name').val("");
    $('#rename_campaign_modal')
        .modal({
            closable : false,
            onApprove : function() {
                var formdata = {'campaign_id': campaign_id,
                                'new_campaign_name': $('#new_campaign_name').val()
                               };
                $.ajax({
                    url: "{{pomspath}}/campaign_rename_name",
                    type: 'GET',
                    data: formdata,
                    success: function(data){
                        data = JSON.parse(data);
                        if (data.message != "ok") {
                            mod_form= $("#display_message_modal").modal('show');
                            $("#poms_message_data").text(data.message);
                        } else {
                            location.reload(true);
                        }
                    }
                });
            }
        })
    .modal('show');
}


function pop_tag_untag_modal() {
    var csv = [];
    var max_rows = $("#c_table_max_rows").val();
    for (var i = 1; i <= max_rows; i++) {
        if ( $("#c_cbox_"+i).is(":checked") ) {
            csv.push($("#c_id_"+i).html());
        }
    }
    if (csv.length == 0) {
        mod_form= $("#display_message_modal").modal('show');
        $("#poms_message_data").text("Please select one or more campaigns by using the appropriate check boxes.");
        return;
    }
    mod_form = $("#tag_untag_modal").modal('setting', 'closable', false).modal('show');
    mod_form.find('span').html("Tag " + csv.length + " selected campaigns...");
    // console.log("csv="+csv);
    $("#tag_campaign_ids").val(csv.join(','))

    $('#tag_container').html('<i class="big spinner loading blue icon"></i>');
    $.getJSON('search_all_tags?cl='+csv.join(','), function (data) {
        if (data.msg == "OK") {
            $('#tag_container').html('');
            for (const tag of data.result) {
                const [tag_id, tag_name] = tag;
                const cids = csv.join('c');
                const new_tag = `<span><a href="{{pomspath}}/search_tags?q=${encodeURIComponent(tag_name)}" class="ui blue tag label" id="${cids}_${tag_id}_">${tag_name}</a>`;
                const new_trash_can = `<i class="trash outline bordered inverted blue icon link poms_tag" id="${cids}_${tag_id}" style="border-radius: 5px;"></i></span>`;
                $('#tag_container').append(new_tag + new_trash_can);
                add_click_handler();
            }
        }
        else {
            $('#response').html(data.msg);
        }
    });
}

$(document).ready(function () {
    add_click_handler();
});

function add_click_handler() {
    $(".poms_tag").off("click").on("click", function () {
        if (confirm("Are you sure you want to delete this item?") == true) {
            do_delete(this);
        }
        else {
            return;
        }
    });
}

function do_delete(item) {
    var c_id = item.id.split("_")[0];
    var t_id = item.id.split("_")[1];
    var clicked_id = "#" + item.id;
    var experiment = "{{session_experiment}}";
    c_id = c_id.replace(/c/g, ',')

    $.post('delete_campaigns_tags', { campaign_id: c_id, tag_id: t_id, experiment: experiment, delete_unused_tag: true }, function (data) {
        if (data.msg == "OK") {
            $('#response').html(data.msg);
            $(clicked_id).remove();  //removes the trash can
            $(clicked_id + "_").remove();  //removes the tag
        }
        else {
            $('#response').html(data.msg);
        }
    });
}

$('#add_button').on('click', function (e) {
    e.preventDefault();
    $('#response').html("");

    if (!$('#tag_field').val()) {
        $('#response').html("Please enter a tag.");
        return;
    }

    tag = $('#tag_field').val()
    console.log("tag " + tag)
    $.post('link_tags', {
                tag_name: tag,
                campaign_id: $("#tag_campaign_ids").val(),
                experiment: "{{session_experiment}}"
            }, function (data) {

        if (data.msg == "OK") {
            const campaigns_tags_composite_key = data.campaign_id.toString().replace(/,/g, 'c') + "_" + data.tag_id.toString();
            $('#response').html(data.msg);

            const new_tag = `<span><a href="{{pomspath}}/search_tags?q=${encodeURIComponent(data.tag_name)}" class="ui blue tag label" id="${campaigns_tags_composite_key}_">${data.tag_name}</a>`;
            const new_trash_can = `<i class="trash outline bordered inverted blue icon link poms_tag" id="${campaigns_tags_composite_key}" style="border-radius: 5px;"></i></span>`;
            $('#tag_container').append(new_tag + new_trash_can);
            //$('#tag_container').append(new_tag);
            $('#tag_field').val("");
            add_click_handler();
        }
        else {
            $('#response').html(data.msg);
        }

    });
});

$('#tag_field').keypress(function (event) {
    if (event.keyCode == 13) {
        $('#add_button').click();
        $('#tag_field').val("");
    }
});

</script>

<script>
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    const appname = window.location.pathname.split("/")[1];
    const querypath = `${protocol}//${hostname}/${appname}/auto_complete_tags_search`;

    const experiment = "{{session_experiment}}";
    $('.ui.search')
        .search({
            apiSettings: {
                url: querypath + "?q={query}&experiment=" + experiment
            },
            fields: {
                title: 'name'
            },
            //minCharacters : 3
        });

    $("#mark_inactive_modal").submit(function(event) {
        event.preventDefault();
        var formdata = {'is_active': $('input[name=is_active]:checked').val(),
                        'cl': $("#campaign_ids").val()
                       };
        $.ajax({
            url: "{{pomspath}}/mark_campaign_active",
            type: 'GET',
            data: formdata,
            success: function(data){
                $('#mark_inactive_modal').modal('toggle');
                location.reload(true);
            }
        })
    });

    function pop_mark_inactive_modal() {
        var max_rows = $("#c_table_max_rows").val();
        var names = [];
        var ids = [];
        for (var i = 1; i <= max_rows; i++) {
            if ( $("#c_cbox_"+i).is(":checked") ) {
                names.push($("#c_name_"+i).html());
                ids.push($("#c_id_"+i).html());
            }
        }
        if (names.length == 0) {
            mod_form= $("#display_message_modal").modal('show');
            $("#poms_message_data").text("Please select one or more campaigns by using the appropriate check boxes.")
        }
        else {
            mod_form = $("#mark_inactive_modal").modal('show');
            $("#campaign_names").val( names.join('\n') );
            $("#campaign_ids").val(ids.join(','))
        }
    }

</script>

{%endblock%}
