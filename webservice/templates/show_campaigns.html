{%extends "layout.html"%}

{%block title%}
POMS: Campaign Stages

<script>
    function pop_mark_inactive_modal() {
        mod_form = $("#mark_inactive_modal").modal('show');
        var csv = [];
        // find only visible rows; we're ignoring filtered/hidden rows
        $("#campaigns").find('tbody tr:visible').find('td:nth-child(1)').each(function() {
            csv.push( $(this).text() );
        });
        mod_form.find('span').html("Mark " + csv.length + " selected campaigns as ");
        console.log("csv="+csv);
        $("#campaign_ids").val(csv.join(','))
    }
</script>

{%endblock%}

{%block header%}
Campaign Stages{%include 'help_button.html'%}
{%endblock%}

{%block content%}

{#set column_heads = ['All','Idle','Running','Held','Total Completed','Completed', 'Located', 'Removed', 'efficiency', 'pending' ] #}
{%set column_heads = [] %}

<style scoped>
    table th {
        font-weight: bold !important;
        padding-right: 12px !important;
    }

    #campaigns th:nth-child(1), table td:nth-child(1) {
        display: none;
    }
</style>

<div class="ui {{ 'disabled' if (not current_experimenter.is_root()) }} teal button" onclick="pop_mark_inactive_modal()">Mark Campaign Active/Inactive</div>

<div id="double-scroll" class="ui _scrollable">
    <!-- campaigns.0.experiment_obj.restricted: {{campaigns.0.experiment_obj.restricted}} -->
    <!-- current_experimenter.is_authorized(campaigns.0.experiment): {{current_experimenter.is_authorized(campaigns.0.experiment)}} -->
    <!-- campaigns.0.experiment in current_experimenter.extra.selected {{campaigns.0.experiment in current_experimenter.extra.selected}} -->
    <table id="campaigns" class="ui celled _table unstackable tablesorter tablesorter-ice">
        <thead>
            <tr>
                <th class="hideit">Id</th>
                <th>Name</th>
                <th>Active</th>
<!--
                <th>S/W Version</th>
                <th>VO Role</th>
-->
                <th>Creator</th>
                <th data-sorter="shortDate" data-dateFormat="yyyymmdd">Created</th>
            </tr>
        </thead>
        <tbody>
            {% for campaign in campaigns if current_experimenter.extra and campaign.experiment in current_experimenter.extra.selected %}
                <tr>
                    <td class="hideit">{{campaign.campaign_id}}</td>
                    <td><a href="{{pomspath}}/campaign_info?campaign_id={{campaign.campaign_id}}">{{campaign.name}}</a></td>
                    <td>{{'Yes' if campaign.active else 'No'}}</td>
<!--
                    <td>{{campaign.software_version}}</td>
                    <td>{{campaign.vo_role}}</td>
-->
                    <td>{{campaign.experimenter_creator_obj.username}}</td>
                    <td>{{campaign.created.strftime('%Y-%m-%d %H:%M:%S')}}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
        $("#campaigns th").attr("style", "padding: 0.3em; border-left: 1;");
        //$('.hideit').hide();
    </script>
</div>

<div class="ui modal small" id="mark_inactive_modal" style="padding: 0px 20px;">
  <i class="close icon"></i>

  <div class="header">
    Campaigns:
  </div>
  <form class="ui form" action="mark_campaign_active" method="GET">
    <div class="field">
        <input type="text" id="campaign_ids" name="cl" readonly>
        <span style="font-size: 1.3em;">Mark selected campaigns as </span>
        <input type="submit" class="ui teal button" name="is_active" value="Active">
        <input type="submit" class="ui teal button" name="is_active" value="Inactive">
    </div>
    <div class="ui hidden divider"></div>
  </form>
</div> <!-- Ends Modal -->

<script>
    var tmin_local_time = moment.utc('{{tmin}}').toDate();
    tmin_local_time = moment(tmin_local_time).format('YYYY-MM-DD HH:mm');
    $( ".tmin" ).html( tmin_local_time );

    var tmax_local_time = moment.utc('{{tmax}}').toDate();
    tmax_local_time = moment(tmax_local_time).format('YYYY-MM-DD HH:mm');
    $( ".tmax" ).html( tmax_local_time );

</script>

<!-- now some JSON callbacks to get our
      * job counts for each campaign,
      * efficiency for all the campaigns
      * pending counts for all the campaigns
-->

<script>
    /*
    $(function() {

        var now = new Date()
        var nows = now.getTime()
        nows = nows - (nows % 300000)
        nows = nows.toString()

        {% for campaign in campaigns %}
        $.getJSON("/poms/json_job_counts?tmin={{tmins}}&tmax={{tmaxs}}&campaign_id={{campaign.campaign_id}}&uuid="+nows,function(data){
            for( var k in data ) {
               id = "data_{{campaign.campaign_id}}_" + k.replace(" ","_")
               console.log("trying to update a with id " + id )
               $("a#"+id).html(data[k])
            }
        })
        {% endfor %}
        $.getJSON("/poms/json_efficiency_for_campaigns?tmin={{tmins}}&tmax={{tmaxs}}&cl={{ campaigns | join(',', attribute='campaign_id') }}&uuid="+nows, function(data) {
            for (var k in data) {
               id = "data_"+k+"_efficiency"
               console.log("trying to update a with id " + id )
               $("a#"+id).html(data[k])
            }
        })
        $.getJSON("/poms/json_pending_for_campaigns?tmin={{tmins}}&tmax={{tmaxs}}&cl={{ campaigns | join(',', attribute='campaign_id') }}&uuid="+nows, function(data) {
            for (var k in data) {
               id = "data_"+k+"_pending"
               console.log("trying to update a with id " + id )
               if (data[k] == -1) {
                   $("a#"+id).html('N/A')
               } else {
                   $("a#"+id).html(data[k])
               }
            }
        })
    });
    */
</script>

<script>
$('.external')
  .popup({
    inline   : true,
    hoverable: true,
    delay: {
      show: 300,
      hide: 80
    }
  })
;
$('.ui.dropdown')
  .dropdown()
;
</script>


<script>
   $(function() {
       $('#global_datepicker_container').show();
   });

   $(document).ready(function() {
     $('#double-scroll').doubleScroll();
   });
</script>

<script>
    $(document).ready(function() {
        $('#campaigns').tablesorter( {
            widgets : [ 'filter', 'saveSort' ],
            widgetOptions : {filter_reset: '.reset', saveSort: true},
            //dateFormat : "yyyymmdd"
            });
    });

    $('#campaigns')
    .bind('filterInit', function() {
        // check that storage ulility is loaded
        if ($.tablesorter.storage) {
            // get saved filters
            var f = $.tablesorter.storage(this, 'tablesorter-filters') || [];
            $(this).trigger('search', [f]);
        }
    })
    .bind('filterEnd', function(){
        if ($.tablesorter.storage) {
            // save current filters
            var f = $(this).find('.tablesorter-filter').map(function() {
                return $(this).val() || '';
            }).get();
            $.tablesorter.storage(this, 'tablesorter-filters', f);
        }
    });
</script>

{%endblock%}
