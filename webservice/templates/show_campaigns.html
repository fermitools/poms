{%extends "layout.html"%}

{%block title%}
    <title>POMS:{{In}}Active Campaign Layers
       {%if limit_experiment %}
           for {{limit_experiment}}
       {%endif%}
   </title>
{%endblock%}


{%block breadcrumbs%}
<div class="ui breadcrumb" style="margin-top: -45px;">
  <a href="{{pomspath}}/" class="section">Home</a>
  <div class="divider"> / </div>
  <div class="section">Campaign Layers</div>
</div>
{%endblock%}


{%block header%}
<h1 class="ui header">
     Campaign Layers{%include 'help_button.html'%}
       {%if limit_experiment %}
           for {{limit_experiment}}
       {%endif%}
</h1>
{%endblock%}




{%block subheader%}
<!--
    <h2 class="ui dividing header">{{In}}Active Campaign Layers <!--for {{time_range_string}} - ->
           {%if limit_experiment %}
               for {{limit_experiment}}
           {%endif%}
    </h2>
    -->
    <!-- <div class="ui two column doubling stackable grid container"> -->
    <div class="ui grid container">
        <h2 class="ui __dividing header">{{In}}Active Campaign Layers<!--for {{time_range_string}} -->
               {%if limit_experiment %}
                   for {{limit_experiment}}
               {%endif%}
        </h2>
        <form method="POST" class="ui form">
            <select class="ui inline __search dropdown" multiple="multiple" name="exp_selected">
                <option value="">Experiments</option>
                {# for c in cl if not c.experiment_obj.restricted or current_experimenter.is_authorized(c.experiment) #}
                {% for e in experiments %}
                    <!-- e: "{{e}}" "{{e.4}}" -->
                    <option value="{{e.0}}" {{'selected' if e.4 or e.0 in current_experimenter.extra.selected }}>{{e.0}}</option>
                {% endfor %}
            </select>
<!--
            <div class="ui compact inline __primary submit button">Save</div>
-->
            <input type="submit" value="Update" class="ui inline mini compact __teal button" />
        </form>
    </div>
    <br>
    <a href="{{prev}}">&lt;previous {{days}} days</a> |
    <a href="{{next}}">next {{days}} days &gt;</a>

    <div class="ui basic label">
      <i class="wait icon"></i>  <div class="tmin" style="display:inline;"></div> to <div class="tmax" style="display:inline;"></div>
    </div>

{%endblock%}




{%block content%}
<style>
    /* Patch for semantic ui dropdown to make it horizontally aligned */
    .ui.selection.dropdown {
        line-height: 2em;
    }
</style>
<!--
 {{counts}}
 {{counts_keys}}
 current_experimenter: {{current_experimenter}}
 authorized_for: {{current_experimenter.authorized_for}}
 extra: {{current_experimenter.extra}}
 experiments: {{experiments}}
 dbg: {{dbg}}
-->

  <div class="ui">


   <table class="ui celled table unstackable">
     <tr>
       <th colspan = 6></th>
       <th colspan = 4>Jobs in  {{time_range_string}}</th>
     </tr>
     <tr>
       <th colspan=2 align="center"> Campaign Layer
        <a target="_help" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Campaign"><i style="float: none" class="grey help circle link icon"></i></a>
      </th>
      <th>Total</th>
      <th colspan=3 align="center">Active Jobs </th>
      <th colspan=3 align="center">Completed </th>
      <th colspan=1 align="center"></th>
      <th colspan=2 align="center">Stats</th>
     </tr>
     <tr>
        <th>Experiment </th>
        <th>Name </th>
        <th>All</th>
        <th>Idle
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>Running
        <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>Held
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>Total
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>Not Located
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>Located
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>Removed
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>%Efficiency
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
        <th>Pending
          <a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/Glossary#Job"><i style="float: none" class="grey help circle link icon"></i></a>
        </th>
     </tr>

     {# for c in cl if not c.experiment_obj.restricted or current_experimenter.is_authorized(c.experiment) #}
     {# for c in cl if not c.experiment_obj.restricted or c.experiment in current_experimenter.extra.selected #}
     {% for c in cl if c.experiment in current_experimenter.extra.selected %}
     {% set outer_loop = loop %}
            <tr>
            <td>{{c.experiment}}</td>
            <!-- c.experiment_obj.restricted: {{c.experiment_obj.restricted}} -->
            <!-- current_experimenter.is_authorized(c.experiment): {{current_experimenter.is_authorized(c.experiment)}} -->
            <!-- c.experiment in current_experimenter.extra.selected {{c.experiment in current_experimenter.extra.selected}}-->
            <td> <a href="{{pomspath}}/campaign_info?campaign_id={{c.campaign_id}}">{{c.name}}</a></td>
            {% for k in counts_keys[c.campaign_id] %}
              {% if k == "efficiency" %}
                <td>
                  <a href="{{pomspath}}/jobs_eff_histo?campaign_id={{c.campaign_id}}&tmin={{tmins}}&tmax={{tmaxs}}&tdays={{tdays}}">
                   {% if counts[c.campaign_id][k] >= 0 %}
                    {{counts[c.campaign_id][k]}}
                   {% else %}
                    -
                   {% endif %}
                  </a>
                </td>
              {% elif k == "pending" %}
                <td>
                  <a href="{{pomspath}}/show_dimension_files?experiment={{c.experiment}}&dims={{dimlist[outer_loop.index0]}}">
                   {% if counts[c.campaign_id][k] >= 0 %}
                    {{counts[c.campaign_id][k]}}
                   {% else %}
                    -
                   {% endif %}
                  </a>
                </td>
              {% elif k %}
                <td>
                  <a href="{{pomspath}}/job_table?campaign_id={{c.campaign_id}}&job_status={{k}}&tmin={{tmins}}&tmax={{tmaxs}}&tdays={{tdays}}">
                    {{counts[c.campaign_id][k]}}
                  </a>
                 </td>
               {%endif%}
            {% endfor %}
         </tr>

     {% endfor %}

    </table>
  </div>

<script>
var tmin_local_time = moment.utc('{{tmin}}').toDate();
tmin_local_time = moment(tmin_local_time).format('YYYY-MM-DD HH:mm');
$( ".tmin" ).html( tmin_local_time );

var tmax_local_time = moment.utc('{{tmax}}').toDate();
tmax_local_time = moment(tmax_local_time).format('YYYY-MM-DD HH:mm');
$( ".tmax" ).html( tmax_local_time );
</script>



<script>
$('.external')
  .popup({
    inline   : true,
    hoverable: true,
    delay: {
      show: 300,
      hide: 80
    }
  })
;
$('.ui.dropdown')
  .dropdown()
;
</script>


<script>
$(function() {
    $('#global_datepicker_container').show();
});
</script>

{%endblock%}
