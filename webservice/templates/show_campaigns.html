{%extends "layout.html"%}

{%block title%}
POMS: Campaign Stages

<script>
    function pop_mark_inactive_modal() {
        mod_form = $("#mark_inactive_modal").modal('show');
        var csv = [];
        // find only visible rows; we're ignoring filtered/hidden rows
        $("#campaigns").find('tbody tr:visible').find('td:nth-child(1)').each(function() {
            csv.push($(this).text());
        });
        $("tempid1, span").html("Mark " + csv.length + " selected campaigns as ");
        console.log("csv="+csv);
        $("#campaign_ids").val(csv.join(','))
    }


    function pop_launch_holder_modal() {
        mod_form = $("#launch_holder_modal").modal('show');
        var csv = [];
        // find only visible rows; we're ignoring filtered/hidden rows
        $("#campaigns").find('tbody tr:visible').find('td:nth-child(1)').each(function() {
            csv.push($(this).text());
        });
        $("#tempid2, span").html("Mark " + csv.length + " selected campaigns as ");
        console.log("csv="+csv);
        $("#campaign_ids2HR").val(csv.join(','))
    }


    function show_stats() {
        var csv = [];
        // find only visible rows; we're ignoring filtered/hidden rows
        $("#campaigns").find('tbody tr:visible').find('td:nth-child(1)').each(function() {
            csv.push($(this).text());
        });
        console.log("csv="+csv);
        location.href = "./show_campaigns?cl=" + csv.join(',');
    }
</script>

{%endblock%}

{%block header%}
Campaign Stages{%include 'help_button.html'%}
{%endblock%}

{%block content%}

{#set column_heads = ['All','Idle','Running','Held','Total Completed','Completed', 'Located', 'Removed', 'efficiency', 'pending' ] #}
{%set column_heads = [] %}

<style scoped>
    table th {
        font-weight: bold !important;
        padding-right: 12px !important;
    }

    #campaigns th:nth-child(1), table td:nth-child(1) {
        display: none;
    }
</style>

<div class="ui {{ 'disabled' if (not current_experimenter.is_root()) }} teal button" onclick="pop_mark_inactive_modal();">Mark Campaign Active/Inactive</div>
<div class="ui teal button" onclick="show_stats();">Show Campaigns Statistics</div>
<div class="ui teal button" onclick="pop_launch_holder_modal();">Hold/Release Campaign Submission</div>

{% if campaigns|length == 0 %}
<br>
[No Campaigns Available]
{% else %}
<div id="double-scroll" class="ui _scrollable">
    <table id="campaigns" class="ui celled _table unstackable tablesorter tablesorter-ice">
        <thead>
            <tr>
                <th class="hideit">Id</th>
                <th>Name</th>
                <th>Active</th>
                <th>Tags</th>
                <th>Hold By</th>
                <th>Creator</th>
                <th data-sorter="shortDate" data-dateFormat="yyyymmdd">Created</th>
            </tr>
        </thead>

        <tbody>
            {% for campaign in campaigns if current_experimenter.extra and campaign.experiment in current_experimenter.extra.selected %}
                <tr>
                    <td class="hideit">{{campaign.campaign_id}}</td>
                    <td><a href="{{pomspath}}/campaign_info?campaign_id={{campaign.campaign_id}}">{{campaign.name}}</a></td>
                    <td>{{ 'Yes' if campaign.active else 'No' }}</td>
                    <td>{{ campaign.campaigns_tags | join('<br>', attribute='tag_obj.tag_name') }}</td>
                    <td>{{campaign.experimenter_holder_obj.username}}</td>
                    <td>{{campaign.experimenter_creator_obj.username}}</td>
                    <td>{{campaign.created.strftime('%Y-%m-%d %H:%M:%S')}}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <script>
        $("#campaigns th").attr("style", "padding: 0.3em; border-left: 1;");
        //$('.hideit').hide();
    </script>
</div>
{% endif %}

<div class="ui modal small" id="mark_inactive_modal" style="padding: 0px 20px;">
  <i class="close icon"></i>

  <div class="header">
    Campaigns:
  </div>
  <form class="ui form" action="mark_campaign_active" method="GET">
    <div class="field">
        <input type="text" id="campaign_ids" name="cl" readonly>
        <span id="tempid1" style="font-size: 1.3em;">Mark selected campaigns as </span>
        <input type="submit" class="ui teal button" name="is_active" value="Active">
        <input type="submit" class="ui teal button" name="is_active" value="Inactive">
    </div>
    <div class="ui hidden divider"></div>
  </form>
</div> <!-- Ends Modal -->

<div class="ui modal small" id="launch_holder_modal" style="padding: 0px 20px;">
  <i class="close icon"></i>

  <div class="header">
    Campaigns to Hold/Release:
  </div>
  <form class="ui form" action="mark_campaign_hold" method="GET">
    <div class="field">
        <input type="text" id="campaign_ids2HR" name="ids2HR" readonly>
        <span id="tempid2" style="font-size: 1.3em;">Mark selected campaigns as </span>
        <input type="submit" class="ui teal button" name="is_hold" value="Hold">
        <input type="submit" class="ui teal button" name="is_hold" value="Release">
    </div>
    <div class="ui hidden divider"></div>
  </form>
</div> <!-- Ends Modal -->

<script>
    var tmin_local_time = moment.utc('{{tmin}}').toDate();
    tmin_local_time = moment(tmin_local_time).format('YYYY-MM-DD HH:mm');
    $( ".tmin" ).html( tmin_local_time );

    var tmax_local_time = moment.utc('{{tmax}}').toDate();
    tmax_local_time = moment(tmax_local_time).format('YYYY-MM-DD HH:mm');
    $( ".tmax" ).html( tmax_local_time );

</script>


<script>
    $('.external')
      .popup({
        inline   : true,
        hoverable: true,
        delay: {
          show: 300,
          hide: 80
        }
      })
    ;
    $('.ui.dropdown')
      .dropdown()
    ;
</script>


<script>
   $(function() {
       $('#global_datepicker_container').show();
   });

   $(document).ready(function() {
     $('#double-scroll').doubleScroll();
   });
</script>

<script>
    $(document).ready(function() {
        $('#campaigns').tablesorter( {
            widgets : [ 'filter', 'saveSort' ],
            widgetOptions : {filter_reset: '.reset', saveSort: true},
            //dateFormat : "yyyymmdd"
            });
    });

    $('#campaigns')
    .bind('filterInit', function() {
        // check that storage ulility is loaded
        if ($.tablesorter.storage) {
            // get saved filters
            var f = $.tablesorter.storage(this, 'tablesorter-filters') || [];
            $(this).trigger('search', [f]);
        }
    })
    .bind('filterEnd', function(){
        if ($.tablesorter.storage) {
            // save current filters
            var f = $(this).find('.tablesorter-filter').map(function() {
                return $(this).val() || '';
            }).get();
            $.tablesorter.storage(this, 'tablesorter-filters', f);
        }
    });
</script>

{%endblock%}
