{%extends "layout.html" %}

{%block title%}
POMS Job Triage
{%endblock%}

{%block header%}
<h1 class="ui header">
         Job Triage{%include 'help_button.html'%}

          <div class="sub header">
              triage your jobs
         </div>
</h1>
{%endblock%}




{%block subheader%}
<h2 class="ui dividing header">Job Triage:</h2>
{%endblock%}



{%block content %}





<table class="ui celled table">
  <thead>
    <tr>
      <th>Status</th>
      <th>CPU Efficiency</th>
      <th>Host Site</th>
      <th>Node Name</th>
      <th>CPU</th>
      <th>Jobsub_Job_ID</th>
      <th>Submission ID</th>
      <th>Usr Exe Exit Code</th>
      <th>Updated</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td {% if job_info.Job.status == "Completed" %} class="positive">  <i class="icon checkmark"></i>  {% else %} >  {% endif %}      {{job_info.Job.status}}</td>
      <td>{{efficiency}}{% if efficiency != None %}%{%endif%}</td>
      <td>{{job_info.Job.host_site}}</td>
      <td>{{job_info.Job.node_name}}</td>
      <td>{{job_info.Job.cpu_type}}</td>
      <td>{{job_info.Job.jobsub_job_id}}</td>
      <td>{{job_info.Job.task_id}}</td>
      <td>{{job_info.Job.user_exe_exit_code}}</td>
      <td>{{job_info.Job.updated}}</td>
    </tr>


  </tbody>
</table>

{% if job_info.Job.status == "Held" %}
Held because: {{job_info.Job.reason_held}}
{% endif %}


{% if job_info.Task.project is not none %}
<h4 class="ui horizontal divider header">
      <i class="linkify icon"></i>
      SAM Project
</h4>
<a target="_blank" href="http://samweb.fnal.gov:8480/station_monitor/{{job_info.Campaign.experiment}}/stations/{{job_info.Campaign.experiment}}/projects/{{job_info.Task.project}}">http://samweb.fnal.gov:8480/station_monitor/{{job_info.Campaign.experiment}}/stations/{{job_info.Campaign.experiment}}/projects/{{job_info.Task.project}}</a>
{% endif %}




<!--<h2 class="ui dividing header">Logs:</h2>-->

<h4 class="ui horizontal divider header">
      <i class="file outline icon"></i>
      Logs
</h4>

<button onclick="location.href='{{pomspath}}/triage_job?job_id={{job_id}}&tmin={{tmin}}&force_reload=True';" class="ui button">Refetch &nbsp;&nbsp;&nbsp;<i class="refresh icon"></i></button>
<br/>
<br/>



{% set jobsub_job_id_digits = job_info.Job.jobsub_job_id.split('@')[0] %}


<span style="display:inline-block; min-width: 6em; text-align: right">Size</span> &nbsp; Name <br/>

{% if job_file_list %}
{% for item in job_file_list %}

<span style="display:inline-block; min-width: 6em; text-align: right">{{item[2]}}</span> &nbsp;
{% if item|length > 5 and item[5].find(jobsub_job_id_digits) > -1 %}
<mark>
<a href="{{pomspath}}/job_file_contents?job_id={{job_id}}&task_id={{job_info.Job.task_id}}&tmin={{tmin}}&file={{item[5]}}">{{item[5]}}</a>
</mark>
{% else %}
<a href="{{pomspath}}/job_file_contents?job_id={{job_id}}&task_id={{job_info.Job.task_id}}&tmin={{tmin}}&file={{item[5]}}">{{item[5]}}</a>
{% endif %}
<br/>

{% endfor %}
{% endif %}














<!--<h2 class="ui dividing header">General Job Info:</h2>-->

<h4 class="ui horizontal divider header">
      <i class="bar chart icon"></i>
      General Specifications
</h4>

<table class="ui definition table">
    <tbody>
      <tr>
        <td class="three wide">Experiment</td>
        <td>
          <p>{{job_info.Campaign.experiment}}</p>
        </td>
      </tr>

      <tr>
        <td>Campaign Stage</td>
        <td>
          <p>{{job_info.Campaign.name}}</p>
        </td>
      </tr>
      <tr>
        <td>Command Executed</td>
        <td>
          <pre>{{job_info.Task.command_executed}}</pre>
        </td>
      </tr>
      <tr>
        <td>Job Type Name</td>
        <td>
          <p>{{job_info.CampaignDefinition.name}}</p>
        </td>
      </tr>
      <tr>
        <td>Submission Status</td>
        <td>
          <p>{{job_info.Task.status}}</p>
        </td>
      </tr>
      <tr>
        <td>VO Role</td>
        <td>
          <p>{{job_info.Campaign.vo_role}}</p>
        </td>
      </tr>
    </tbody>
  </table>

<h4 class="ui horizontal divider header">
      <i class="history icon"></i>
      Downtimes
</h4>

<a href="https://fermi.service-now.com/home.do?sysparm_view=scd_outage_calendar&sysparm_auto_request=true" target="_popup" >Downtime Calendar</a>

<h4 class="ui horizontal divider header">
      <i class="history icon"></i>
      History
</h4>

<table class="ui very basic collapsing celled table">
        <tbody>
          <tr>
            <td class="six wide">Event</td>
            <td class="six wide">Timestamp</td>
          </tr>
          {% for item in job_history %}
          <tr>
            <td><code>{{item.status}}</code></td>
            <td>{{item.created}}</td>
          </tr>
          {% endfor %}
        </tbody>
</table>








{% if downtimes %}
<h4 class="ui horizontal divider header">
      <i class="warning sign icon"></i>
      Downtimes
</h4>




<table class="ui very basic collapsing celled table">
        <tbody>
          <tr>
            <td class="six wide">Service</td>
            <td class="six wide">Downtime Started</td>
            <td class="six wide">Downtime Ended</td>
          </tr>
          {% for item in downtimes %}
          <tr>
            <td><code>{{item.Service.name}}</code></td>
            <td>{{item.ServiceDowntime.downtime_started}}</td>
            <td>{{item.ServiceDowntime.downtime_ended}}</td>
          </tr>
          {% endfor %}
        </tbody>
</table>
{% endif %}






{% if output_file_names_list %}
<h4 class="ui horizontal divider header">
      <i class="file outline icon"></i>
      Output File Names
</h4>
{%for item in output_file_names_list%}
{{item}}
<br/>
{% endfor %}
{% endif %}

















<h4 class="ui horizontal divider header">
      <i class="lightning icon"></i>
      Condor Event Logs
</h4>


        <style>
        .hid {
            display: none;
            background-color: #efefef;
        }

        th, td {
            padding: 3px 5px 5px 5px;
        }

        .toggler
        {
            cursor:pointer;
        }
        </style>



        <script>
            $( document ).ready(function() {
                        $(".toggler").click(function(){
                                $(this).closest('tr').next('tr').toggle();

                                if ( $(this).text() == "+" )
                                {
                                    $(this).text("-");
                                }
                                else
                                {
                                    $(this).text("+");
                                }
                        });  //ends click handler
            });  //ends dom ready
        </script>



                <table class="ui celled striped table">


                    <thead>
                        <tr>
                            <th width="1%"></th>
                            <th><span>Time</span></th>
                            <th><span>Event</span></th>
                        </tr>
                    </thead>



                    <tbody>  <!-- root tbody-->

                    {% if es_response %}
                    {% for record in es_response.get('hits',{}).get('hits',[]) %}
                    {% set record_meat = record.get('_source') %}
                        <!--item-->
                        <tr>
                            <td class="toggler">+</td>
                            <td width="30%">{{record_meat.get("@timestamp")}}</td>
                            <td>{{record_meat.get("event_message")}}</td>
                        </tr>


                        <tr class="hid">
                            <td colspan="3">
                                <table>
                                    <tbody>
                                        {% for key, value in record_meat.items() %}
                                        <tr>
                                            <td><b>{{ key|e }}</b></td>
                                            <td width="1%" style="display:none;"></td>
                                            <td>{{ value|e }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        <!--ends item-->
                    {% endfor %}
                    {% endif %}



                    </tbody>  <!--ends root tbody-->

                </table>  <!--ends root table-->

{%if es_response%}
<small>{{es_response.get('hits',{}).get('total',0)}} records in {{es_response.get('took',0)}} ms</small>
{% endif %}



{%endblock%}
