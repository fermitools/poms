{%extends "layout.html"%}

{%block title%}
POMS
{%endblock%}

{%block header%}
<h1 class="ui header">
  Info by day{%include 'help_button.html'%}
</h1>
<!--<div class="ui subheader">
{{tdays}} Days ending  {{tmax}}
</div>-->

<a href="{{prev}}">&lt;previous {{tdays}} days</a> |
<a href="{{next}}">next {{tdays}} days &gt;</a>
{%endblock%}


{%block subheader%}
<div class="ui basic label">
  <i class="wait icon"></i>  <div class="tmin" style="display:inline;"></div> to <div class="tmax" style="display:inline;"></div>
</div>
{%endblock%}


{%block content%}
<div id="double-scroll" class="scrollable">
  <table class="ui sortable celled collapsing table">
    <thead>
      <tr>
      {% for col in columns %}
         <th class="">
           {%- if col[:4] == 'exit' -%}
               {%- if col|length > 9  -%}
                  {{col}}<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/CampaignSheetHelp#exit_signal"><i class="small icon grey help circle  link"></i></a>
               {%- else -%}
                  <a href="https://cdcvs.fnal.gov/redmine/projects/offline_production_operations_service/wiki/_{{session_experiment}}_error_codes_#{{col[5:-1]}}">{{col}}</a><a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/CampaignSheetHelp#exit"><i class="small icon grey help circle link"></i></a>
               {%- endif -%}
           {%- else -%}
               {{col}}<a target="_blank" href="https://cdcvs.fnal.gov/redmine/projects/prod_mgmt_db/wiki/CampaignSheetHelp#{{col|replace(' ','_')}}"><i class="small icon grey help circle link"></i></a>
           {%- endif -%}
         </th>
      {%endfor%}
      </tr>
    </thead>
    <tbody>
        {% for row in datarows %}
        {% set outer_loop = loop %}
        <tr>
           {%for col in range(0, columns|count) %}
              {% if columns[col] == 'efficiency%' %}
                <td><a href="{{pomspath}}/jobs_eff_histo?campaign_stage_id={{campaign_stage_id}}&tmax={{row[1][:10]}} 23:59:59">
                 {{ 'N/A' if row[col] == -1 or row[col] == '-' else row[col] }}
              </a></td>
              {% elif columns[col] == 'pending' %}
                <td>
                    <a href="{{pomspath}}/campaign_task_files?&tmax={{row[1][:10]}} 23:59:59&campaign_stage_id={{campaign_stage_id}}" id="data_{{row[1][:10]}}">
                        ...
                    </a>
                </td>
              {% elif columns[col][:4] == 'exit' %}
                <td><a href="{{pomspath}}/job_table?user_exe_exit_code={{columns[col][5:-1]}}&tdays=1&tmax={{row[1][:10]}} 23:59:59&campaign_stage_id={{campaign_stage_id}}">{{row[col]}}</a></td>
              {% elif columns[col][:4] == 'jobs' %}
                <td><a href="{{pomspath}}/job_table?tdays=1&tmax={{row[1][:10]}} 23:59:59&campaign_stage_id={{campaign_stage_id}}">{{row[col]}}</a></td>
              {% elif columns[col] == 'No exitcode' %}
                <td><a href="{{pomspath}}/job_table?user_exe_exit_code=None&tdays=1&tmax={{row[1][:10]}} 23:59:59&campaign_stage_id={{campaign_stage_id}}">{{row[col]}}</a></td>
              {% elif columns[col][-5:] == 'files' %}
                <td><a href="{{pomspath}}/campaign_task_files?&tmax={{row[1][:10]}} 23:59:59&campaign_stage_id={{campaign_stage_id}}">{{row[col]}}</a></td>
              {% else %}
                <td>{{row[col]}}</td>
              {% endif %}
           {%endfor%}
        </tr>
      {%endfor%}
    </tbody>
  </table>
</div>






<script>
var tmin_local_time = moment.utc('{{tmin}}').toDate();
tmin_local_time = moment(tmin_local_time).format('YYYY-MM-DD HH:mm');
$( ".tmin" ).html( tmin_local_time );

var tmax_local_time = moment.utc('{{tmax}}').toDate();
tmax_local_time = moment(tmax_local_time).format('YYYY-MM-DD HH:mm');
$( ".tmax" ).html( tmax_local_time );
</script>




<script>
$(function() {

var now = new Date()
var nows = now.getTime()
nows = nows - (nows % 300000)

{%for row in datarows %}
$.getJSON("/poms/json_pending_for_campaigns?tmin={{row[1][:10]}} 00:00:00&tmax={{row[1][:10]}} 23:59:59&cl={{campaign_stage_id}}&uuid="+nows, function(data){
    for( var k in data ) {
       id = "data_{{row[1][:10]}}"
       console.log("trying to update a with id " + id )
       if (data[k] == -1) {
           $("a#"+id).html('N/A')
       } else {
           $("a#"+id).html(data[k])
       }
    }
})
{%endfor%}
});
</script>

<script>
  $(function() {
      $('#global_datepicker_container').show();
  });

  $(document).ready(function(){
    $('#double-scroll').doubleScroll();
  });
</script>
{%endblock%}
